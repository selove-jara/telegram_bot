package org.example.service;

import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.annotation.PostConstruct;
import org.example.model.Categories;
import org.example.repository.CategoriesRepository;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.net.URL;
import java.util.*;


@Service
public class CategoriesService {

    private final ObjectMapper objectMapper;
    private final CategoriesRepository categoriesRepository;
    private final String url = "https://static-basket-01.wbbasket.ru/vol0/data/main-menu-ru-ru-v3.json";
    private List<Categories> categories = new ArrayList<>();

    public CategoriesService(ObjectMapper objectMapper, CategoriesRepository categoriesRepository) {
        this.objectMapper = objectMapper;
        this.categoriesRepository = categoriesRepository;
    }

    @PostConstruct
    public void fetchCategoriesOnStartup() {
        try {
            processCategories();
            saveCategoriesToDatabase();
        } catch (IOException e) {
            throw new RuntimeException("Ошибка при загрузке категорий: " + e.getMessage(), e);
        }
    }

    private void processCategories() throws IOException {
        List<Categories> loadedCategories = loadCategoriesFromUrl(url);
        categories = filterCategories(loadedCategories);
    }

    private List<Categories> loadCategoriesFromUrl(String url) throws IOException {
        return objectMapper.readValue(new URL(url), new TypeReference<List<Categories>>() {});
    }

    private List<Categories> filterCategories(List<Categories> categories) {
        List<Categories> filtered = new ArrayList<>();
        for (Categories category : categories) {
            if (category.getChilds() != null && !category.getChilds().isEmpty()) {
                filtered.add(category);
            }
        }
        return filtered;
    }

    private void saveCategoriesToDatabase() {
        for (Categories category : categories) {
            saveCategoryWithChildren(category, null);
        }
    }

    private void saveCategoryWithChildren(Categories category, Categories parent) {
        // Список ID категорий, которые не нужно сохранять
        Set<Long> excludedIds = new HashSet<>(Arrays.asList(
                307L, 128296L, 8160L, 10520L, 8161L, 8162L, 8163L, 8167L, 8164L, 8165L,
                8166L, 8172L, 8173L, 334L, 335L, 336L, 337L, 338L, 339L, 340L,
                341L, 342L, 343L, 344L, 346L, 347L, 348L, 351L, 60896L, 130762L,
                130761L, 130763L, 130764L, 130765L, 130766L, 130767L, 130768L, 130769L, 130770L, 60897L,
                61439L, 61440L, 61441L, 10016L, 10320L, 130253L, 10318L, 16217L, 10316L, 10315L,
                130254L, 7404L, 128447L, 128448L, 128449L, 128450L, 128451L, 128452L, 128453L, 8838L,
                129175L, 129177L, 130614L, 129179L, 129180L, 129181L, 129182L, 129183L, 129184L, 129185L,
                130616L, 129187L, 129188L, 129190L, 61030L, 131282L, 147L, 8331L, 200L, 9375L,
                131153L, 131154L, 131171L, 131172L, 131173L, 131174L, 131175L, 131176L, 131177L, 131178L,
                131157L, 131160L, 131161L, 131162L, 131163L, 131164L, 131165L, 131166L, 131167L, 131168L,
                131169L, 131158L, 131159L, 131179L, 10384L, 61448L, 567L, 9002L, 9003L, 9004L,
                9005L, 9006L, 9007L, 9009L, 9010L, 60898L, 60899L, 61446L, 61446L, 61447L,
                61486L, 10017L, 7405L, 128454L, 128455L, 128456L, 128457L, 128458L, 128459L, 128460L,
                8839L, 130569L, 130570L, 130583L, 130580L, 130571L, 130572L, 130573L, 130574L, 130575L,
                130577L, 130617L, 130579L, 130576L, 130581L, 128561L, 60461L, 131471L, 131472L, 131473L,
                131474L, 131475L, 130853L, 130854L, 130855L, 130856L, 130857L, 130858L, 130859L, 130860L,
                130861L, 130862L, 130864L, 130865L, 130866L, 130867L, 130868L, 130869L, 130870L, 130871L,
                130872L, 130873L, 130874L, 130863L, 294L, 8462L, 8467L, 131085L, 130146L, 130143L,
                130773L, 130819L, 130774L, 130775L, 130470L, 130776L, 130777L, 130796L, 130778L, 130779L,
                130780L, 130781L, 130782L, 130783L, 130784L, 130785L, 130786L, 130787L, 130788L, 130789L,
                130475L, 130790L, 130791L, 130795L, 130792L, 130793L, 130820L, 130794L, 130471L, 130474L,
                130797L, 130760L, 130758L, 130148L, 130537L, 130538L, 130540L, 130542L, 130544L, 130545L,
                130546L, 130547L, 130548L, 130549L, 130550L, 130551L, 130552L, 130553L, 130554L, 130558L,
                130559L, 130561L, 130563L, 130536L, 130539L, 130543L, 130564L, 130565L, 130567L, 130149L,
                130144L, 130147L, 130145L, 8464L, 60686L, 61866L, 9082L, 15991L, 8054L, 131477L,
                61599L, 130585L, 130586L, 130587L, 130588L, 130589L, 130590L, 130591L, 130592L, 130815L,
                130593L, 130594L, 130595L, 130596L, 130597L, 130598L, 130599L, 130600L, 130601L, 130602L,
                61602L, 61609L, 61708L, 61613L, 61616L, 61623L, 61736L, 61643L, 61699L, 61687L,
                61719L, 61696L, 61601L, 131478L, 131479L, 131480L, 131481L, 131482L, 131483L, 131484L,
                131485L, 131486L, 131487L, 131488L, 131489L, 131490L, 131491L, 131492L, 131493L, 131494L,
                131495L, 131496L, 131497L, 131503L, 131498L, 131499L, 131500L, 131501L, 131502L, 61723L,
                130816L, 61731L, 61639L, 61716L, 61598L, 61712L, 61681L, 130695L, 61649L, 61597L,
                61657L, 130726L, 6399L, 10408L, 130992L, 63092L, 63088L, 13327L, 131366L, 13333L,
                13334L, 63090L, 63089L, 131390L, 60672L, 130193L, 130194L, 130483L, 130523L, 130207L,
                130200L, 130201L, 130204L, 130208L, 130205L, 130209L, 130211L, 130212L, 130215L, 128549L,
                60590L, 60591L, 12784L, 60594L, 60592L, 8394L, 7395L, 17135L, 16664L, 62997L,
                8727L, 60506L, 60644L, 60645L, 60646L, 58992L, 131075L, 131074L, 128331L, 128332L,
                128333L, 58331L, 128306L, 128307L, 15580L, 63017L, 15584L, 60809L, 60808L, 9497L,
                9846L, 9746L, 16292L, 60772L, 60758L, 60763L, 60775L, 62325L, 63080L, 128550L,
                9473L, 59131L, 9476L, 128487L, 9467L, 9464L, 9477L, 9463L, 9475L, 9465L,
                130692L, 9927L, 9466L, 129323L, 130803L, 130798L, 130799L, 130800L, 130801L, 130875L,
                131384L, 130802L, 129324L, 130804L, 130806L, 130805L, 130808L, 130807L, 130809L, 129325L,
                130821L, 130830L, 130826L, 130827L, 130828L, 130829L, 131380L, 131381L, 130822L, 130823L,
                130824L, 130825L, 129326L, 129327L, 130811L, 129328L, 129329L, 130810L, 129330L, 129331L,
                130812L, 129332L, 129322L, 131210L, 130693L, 59065L, 9845L, 130749L, 9834L, 9856L,
                5016L, 130375L, 130401L, 130379L, 130376L, 130377L, 130403L, 130400L, 130402L, 130393L,
                131080L, 130394L, 130378L, 130392L, 130623L, 9496L, 128308L, 10028L, 58397L, 9837L,
                130374L, 10459L, 9924L, 6631L, 130753L, 9508L, 9453L, 7588L, 9240L, 62827L,
                131190L, 131191L, 131198L, 131389L, 131200L, 131201L, 131202L, 131203L, 131204L, 131205L,
                131206L, 131207L, 131208L, 131209L, 131211L, 131212L, 131192L, 131213L, 131214L, 131215L,
                131216L, 131217L, 131218L, 131219L, 131220L, 131221L, 131222L, 131223L, 131224L, 131226L,
                131193L, 131227L, 131228L, 131229L, 131230L, 131231L, 131232L, 131233L, 131234L, 131235L,
                131236L, 131194L, 131237L, 131238L, 131239L, 131240L, 131241L, 131242L, 131243L, 131244L,
                131245L, 131246L, 131247L, 131195L, 131248L, 131249L, 131250L, 131251L, 131252L, 131253L,
                131254L, 131255L, 131256L, 131196L, 131296L, 131258L, 131259L, 131260L, 131261L, 131262L,
                131263L, 131293L, 131294L, 131295L, 131197L, 131264L, 131265L, 131266L, 131267L, 131268L,
                131269L, 131270L, 131271L, 131272L, 131273L, 131281L, 131180L, 131181L, 131182L, 131183L,
                131184L, 131185L, 131186L, 131187L, 131188L, 129027L, 130663L, 129036L, 129037L, 130231L,
                130250L, 129035L, 129041L, 130395L, 130233L, 129039L, 129040L, 130232L, 130884L, 129042L,
                129038L, 129043L, 130885L, 129028L, 129044L, 129045L, 130817L, 130818L, 129102L, 131454L,
                131275L, 131400L, 131401L, 131402L, 131278L, 131279L, 131280L, 129169L, 129170L, 129171L,
                130396L, 130887L, 131453L, 130886L, 130734L, 129029L, 130895L, 129046L, 130888L, 129051L,
                128305L, 129265L, 130889L, 130896L, 130237L, 130397L, 129050L, 129030L, 129058L, 129059L,
                131082L, 130398L, 129055L, 130242L, 130239L, 130240L, 129031L, 129063L, 129060L, 129065L,
                129066L, 129061L, 129032L, 129072L, 129073L, 131038L, 131037L, 131039L, 131040L, 130634L,
                129067L, 130399L, 129070L, 129076L, 129078L, 130241L, 129079L, 129077L, 130248L, 129068L,
                130244L, 130759L, 130890L, 130891L, 130892L, 130893L, 129033L, 129085L, 129084L, 129083L,
                130252L, 130671L, 130235L, 130632L, 130670L, 130238L, 9824L, 62379L, 131007L, 131008L,
                131009L, 131011L, 131014L, 131016L, 131013L, 131012L, 131025L, 131015L, 131010L, 131017L,
                131022L, 131024L, 131021L, 131020L, 131023L, 131019L, 131018L, 131006L, 131030L, 131029L,
                131027L, 6119L, 8471L, 131088L, 131089L, 131090L, 131091L, 131092L, 131093L, 131094L,
                131095L, 131096L, 131109L, 131097L, 131098L, 131099L, 131106L, 131107L, 131108L, 131103L,
                131102L, 131101L, 131104L, 131100L, 6994L, 62554L, 128646L, 128647L, 131346L, 131345L,
                131347L, 131348L, 131349L, 128627L, 128628L, 131504L, 131505L, 131506L, 131507L, 131508L,
                131509L, 131510L, 131511L, 128629L, 128630L, 128632L, 128631L, 128633L, 130917L, 130918L,
                130923L, 130921L, 130924L, 128635L, 128634L, 128636L, 131621L, 131622L, 131623L, 131624L,
                131625L, 131626L, 131627L, 130906L, 128637L, 128638L, 130667L, 128640L, 128641L, 128642L,
                128643L, 130705L, 130754L, 130704L, 17147L, 130755L, 128656L, 128659L, 129173L, 129262L,
                129263L, 129260L, 129261L, 129014L, 130959L, 128663L, 130675L, 130676L, 130677L, 130678L,
                130679L, 130680L, 130681L, 130682L, 130683L, 130691L, 129174L, 128664L, 128662L, 128665L,
                128666L, 128667L, 128670L, 128671L, 131614L, 131615L, 131616L, 128858L, 130720L, 130718L,
                130699L, 130698L, 130700L, 130701L, 130719L, 130702L, 130703L, 129018L, 58377L, 131073L,
                128694L, 128696L, 128697L, 129101L, 128698L, 131000L, 128669L, 128699L, 128859L, 131455L,
                131456L, 131457L, 131458L, 131459L, 131460L, 131461L, 131462L, 131463L, 131464L, 131465L,
                131467L, 131468L, 131469L, 131470L, 131466L, 130624L, 131077L, 131078L, 131079L, 131368L,
                131105L, 519L, 9163L, 9215L, 130935L, 9165L, 9170L, 9168L, 16159L, 60739L,
                58396L, 9164L, 9169L, 9171L, 9167L, 9110L, 9123L, 9118L, 9121L, 9112L,
                9124L, 9120L, 9132L, 9119L, 60113L, 61756L, 9172L, 62706L, 9122L, 9113L,
                129289L, 129287L, 9111L, 61805L, 16213L, 129288L, 9115L, 9116L, 9117L, 9157L,
                129275L, 9134L, 9153L, 9146L, 129276L, 9127L, 129273L, 9150L, 129270L, 129271L,
                9151L, 9138L, 9140L, 9136L, 9155L, 9143L, 9130L, 9129L, 58308L, 16232L,
                16905L, 129272L, 9126L, 129284L, 129167L, 129285L, 129269L, 9131L, 9149L, 9152L,
                129268L, 9133L, 9154L, 9139L, 128334L, 9156L, 9142L, 9135L, 129286L, 9141L,
                9147L, 9128L, 9137L, 128566L, 128567L, 128565L, 128568L, 128564L, 128563L, 128588L,
                128590L, 128589L, 9235L, 9148L, 129279L, 129280L, 129281L, 129282L, 129283L, 129277L,
                9144L, 129278L, 10555L, 130899L, 130905L, 130900L, 130901L, 130903L, 130904L, 130902L,
                130907L, 130908L, 130909L, 130910L, 130911L, 130912L, 130913L, 128312L, 130372L, 130525L,
                62705L, 129274L, 128569L, 128570L, 128571L, 128572L, 128573L, 128574L, 128575L, 128576L,
                128577L, 128578L, 128579L, 128580L, 128581L, 128582L, 128583L, 128584L, 128585L, 128587L,
                128586L, 8051L, 7377L, 1023L, 9300L, 9317L, 9350L, 63069L, 60289L, 63070L,
                9367L, 9370L, 9369L, 63071L, 10198L, 63072L, 1024L, 1031L, 9236L, 63073L,
                17006L, 131151L, 128904L, 128905L, 128906L, 131005L, 131116L, 131115L, 16723L, 16683L,
                16731L, 16735L, 16738L, 58511L, 16789L, 128961L, 128960L, 128967L, 128968L, 128962L,
                128969L, 128963L, 128964L, 128965L, 128966L, 16798L, 128897L, 128898L, 128899L, 128900L,
                128901L, 128902L, 128903L, 17024L, 128939L, 128940L, 128941L, 128942L, 128943L, 128944L,
                128907L, 128908L, 131076L, 128909L, 131110L, 128911L, 128910L, 130993L, 128913L, 128914L,
                128912L, 128915L, 128916L, 131700L, 131713L, 131703L, 131704L, 131705L, 131707L, 131706L,
                131708L, 131710L, 131714L, 131709L, 131711L, 131701L, 131712L, 131702L, 128918L, 131629L,
                131630L, 131631L, 131632L, 131633L, 131635L, 131638L, 131639L, 131640L, 131641L, 131642L,
                131643L, 131644L, 131645L, 131646L, 131647L, 131648L, 131649L, 131637L, 131650L, 131651L,
                131652L, 131653L, 131654L, 131655L, 131656L, 131657L, 131658L, 131659L, 128919L, 128929L,
                128930L, 128931L, 128932L, 128933L, 128934L, 128935L, 128999L, 128936L, 128937L, 128938L,
                128920L, 128928L, 128926L, 128921L, 128925L, 128924L, 129002L, 129000L, 129001L, 128923L,
                128985L, 128927L, 128922L, 4863L, 128760L, 128792L, 128762L, 129189L, 128763L, 128765L,
                131512L, 131513L, 131514L, 131515L, 131516L, 131517L, 131519L, 131520L, 131521L, 131522L,
                131523L, 131524L, 131525L, 131526L, 131527L, 131528L, 131529L, 131530L, 131531L, 131367L,
                130960L, 130961L, 131382L, 128773L, 128843L, 130998L, 130673L, 128741L, 130997L, 128744L,
                128840L, 130999L, 128831L, 131394L, 131392L, 131393L, 128772L, 128807L, 128809L, 128810L,
                131052L, 8744L, 131363L, 128844L, 128845L, 128846L, 128864L, 128847L, 128848L, 128850L,
                128851L, 128852L, 130662L, 128853L, 128854L, 128855L, 128863L, 128740L, 128743L, 131002L,
                131003L, 128745L, 128751L, 128752L, 128753L, 128754L, 128755L, 128756L, 128860L, 128757L,
                128758L, 128759L, 58530L, 128823L, 128825L, 130674L, 128973L, 131112L, 128822L, 130939L,
                128818L, 128821L, 128817L, 128868L, 131170L, 128815L, 128819L, 128824L, 128816L, 130706L,
                128814L, 131365L, 128771L, 128830L, 128834L, 128835L, 128833L, 128832L, 128836L, 128826L,
                128829L, 128827L, 128828L, 128837L, 128767L, 128766L, 128775L, 128777L, 128861L, 128778L,
                128770L, 128806L, 128801L, 128802L, 131086L, 128804L, 128803L, 131087L, 128856L, 128867L,
                128800L, 128768L, 128790L, 128789L, 128786L, 128783L, 128787L, 128782L, 128785L, 128784L,
                128781L, 128788L, 131054L, 128791L, 131361L, 130936L, 128841L, 128838L, 130937L, 10326L,
                131359L, 10327L, 131071L, 131072L, 131055L, 131056L, 131057L, 131058L, 131059L, 131060L,
                131061L, 131062L, 131063L, 131064L, 131065L, 131066L, 131069L, 131068L, 131067L, 131070L,
                10331L, 130696L, 131383L, 10328L, 128310L, 17114L, 10329L, 62257L, 131628L, 63007L,
                10364L, 5515L, 5516L, 62005L, 9176L, 62003L, 61809L, 130371L, 63058L, 131283L,
                131450L, 131534L, 131543L, 131532L, 131535L, 131536L, 131537L, 131533L, 131538L, 131539L,
                131540L, 131541L, 131542L, 131544L, 131111L, 131113L, 131118L, 10296L, 128891L, 128892L,
                128893L, 128894L, 128896L, 58757L, 15816L, 9510L, 9513L, 9515L, 9516L, 9517L, 10558L,
                16720L, 15795L, 63057L, 62320L, 15799L, 62259L, 62260L, 62321L, 62322L, 62319L, 128337L,
                16181L, 10411L, 16713L, 130732L, 62623L, 16714L, 16715L, 128595L, 16716L, 16717L, 16718L,
                17009L, 16719L, 15883L, 15841L, 130838L, 15889L, 16721L, 59104L, 15899L, 9511L, 10299L,
                62466L, 10305L, 10557L, 10297L, 128326L, 128327L, 128328L, 16107L, 9493L, 9491L, 8951L,
                63008L, 62057L, 8174L, 62073L, 10013L, 128338L, 62071L, 62457L, 62198L, 62200L, 62328L,
                62206L, 62204L, 62195L, 62385L, 62201L, 62064L
        ));


        // Проверяем, чтобы shard не был пустым или null, и ID категории не входит в исключения
        if (category.getShard() == null || category.getShard().isEmpty() || excludedIds.contains(category.getId())) {
            return; // Пропускаем сохранение этой категории
        }

        // Сохраняем категорию
        Categories savedCategory = categoriesRepository.save(category);

        // Рекурсивно сохраняем дочерние категории
        if (category.getChilds() != null) {
            for (Categories child : category.getChilds()) {
                saveCategoryWithChildren(child, savedCategory);
            }
        }
    }

    public List<Categories> getCategories() {
        return categories;
    }
}